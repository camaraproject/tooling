# =========================================================================================
# CAMARA Project - Pull Request Validation Workflow
#
# This GitHub Actions is a reusable workflow for validating PRs using tools configuration 
# from subfolder indicated by input `configurations` variable.
# It calls Megalinter tool with the set of configuration variables in "env". 
#
# CONFIGURATION:
# The CONFIG_FILES and CONFIG_DIRS environment variables at the top of this workflow define 
# which items to check for conflicts and verify after copying. They do NOT control what gets
# copied - rsync copies everything from the tooling configuration directory.
#
# CHANGELOG:
# - 2025-08-01: Initial version for v0 version
# - 2025-08-02: Added input validation, enhanced error handling, existing-files-strategy 
#               parameter, and tooling-ref input (due to GitHub Actions limitation - 
#               cannot auto-detect @ref from uses: statement)
#
# FEATURES:
# - Configurable strategy for handling existing configuration files
# - Centralized configuration via environment variables
# - Optional tooling-ref parameter (GitHub Actions doesn't expose the @ref from uses:)
#
# USAGE:
# The action is invoked by Pull Request Validation Workflow Caller in CAMARA API repositories
# Examples:
#   # Using default v0 ref for tooling
#   uses: camaraproject/tooling/.github/workflows/pr_validation.yml@v0
#   with:
#     configurations: "strict"
#
#   # Using a specific tooling ref (when testing new versions)
#   uses: camaraproject/tooling/.github/workflows/pr_validation.yml@test-branch
#   with:
#     configurations: "strict"
#     tooling-ref: test-branch  # Must match the @ref above for consistency
#
# DOCUMENTATION:
# see https://github.com/camaraproject/tooling/tree/main/linting/docs
# =========================================================================================

name: PR validation for CAMARA Project

env:
  # Configuration items to check for conflicts in the workspace
  # These are NOT used to control what gets copied - rsync copies everything from the source
  # They are only used to:
  #   1. Check if these items exist before copying (for existing-files-strategy)
  #   2. Verify these items exist after copying (for validation)
  CONFIG_FILES: ".spectral.yaml .yamllint.yaml .gherkin-lintrc"
  CONFIG_DIRS: "lint-function"

on:
  workflow_call:
    inputs:
      configurations:
        description: 'Subfolder containing tool configs to be used (e.g., "default", "strict", "custom/myconfig")'
        type: string
        required: false
        default: ""
      existing-files-strategy:
        description: 'How to handle existing configuration files: replace, keep, or fail'
        type: string
        required: false
        default: "replace"
      tooling-ref:
        description: 'Ref to use for tooling checkout (defaults to v0). Should match the @ref in uses: for consistency'
        type: string
        required: false
        default: ""

jobs:
  general:
    name: MegaLinter
    runs-on: ubuntu-latest
    steps:
      - name: Validate configurations input
        id: validate-config
        run: |
          CONFIGS="${{ inputs.configurations }}"
          
          # Check for potentially dangerous path traversal
          if [[ "$CONFIGS" == *".."* ]] || [[ "$CONFIGS" == *"//"* ]] || [[ "$CONFIGS" == "/"* ]]; then
            echo "‚ùå Error: Invalid configurations path. Path traversal or absolute paths not allowed."
            exit 1
          fi
          
          # Normalize the path (remove trailing slashes)
          NORMALIZED_PATH="${CONFIGS%/}"
          
          echo "‚úÖ Configurations path validated: '$NORMALIZED_PATH'"
          echo "path=$NORMALIZED_PATH" >> $GITHUB_OUTPUT

      - name: Validate existing-files-strategy
        id: validate-strategy
        run: |
          STRATEGY="${{ inputs.existing-files-strategy }}"
          
          if [[ ! "$STRATEGY" =~ ^(replace|keep|fail)$ ]]; then
            echo "‚ùå Error: Invalid existing-files-strategy: '$STRATEGY'"
            echo "Valid options are: replace, keep, fail"
            exit 1
          fi
          
          echo "‚úÖ Existing files strategy validated: $STRATEGY"
          echo "strategy=$STRATEGY" >> $GITHUB_OUTPUT

      - name: Determine ref for tooling checkout
        id: determine-ref
        run: |
          # Use provided ref or default to v0
          if [[ -n "${{ inputs.tooling-ref }}" ]]; then
            REF="${{ inputs.tooling-ref }}"
            echo "‚ÑπÔ∏è Using provided tooling-ref: $REF"
          else
            REF="v0"
            echo "‚ÑπÔ∏è No tooling-ref specified, using default: $REF"
          fi
          
          echo "ref=$REF" >> $GITHUB_OUTPUT
          
      - name: Validate tooling ref exists
        run: |
          REF="${{ steps.determine-ref.outputs.ref }}"
          echo "üîç Validating that ref '$REF' exists in camaraproject/tooling..."
          
          # Use GitHub API to check if the ref exists
          # This works for branches, tags, and commit SHAs
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/camaraproject/tooling/commits/${REF}")
          
          if [[ "$RESPONSE" == "200" ]]; then
            echo "‚úÖ Ref '$REF' exists in camaraproject/tooling"
          else
            echo "‚ùå Error: Ref '$REF' does not exist in camaraproject/tooling"
            echo "Please check that the ref is correct."
            exit 1
          fi
          
      - name: Display configuration summary
        run: |
          echo "üìã Configuration Summary:"
          echo "  - Configurations subfolder: ${{ steps.validate-config.outputs.path || '(root)' }}"
          echo "  - Tooling checkout ref: ${{ steps.determine-ref.outputs.ref }}"
          echo "  - Existing files strategy: ${{ steps.validate-strategy.outputs.strategy }}"

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Checkout linting config
        id: checkout-config
        uses: actions/checkout@v4
        with:
          repository: camaraproject/tooling
          path: lint-config
          ref: ${{ steps.determine-ref.outputs.ref }}
          sparse-checkout: |
            linting/config/
          sparse-checkout-cone-mode: false
          
      - name: Verify configuration exists
        run: |
          CONFIG_PATH="${{ steps.validate-config.outputs.path }}"
          FULL_PATH="${{ github.workspace }}/lint-config/linting/config/${CONFIG_PATH}"
          
          if [[ -n "$CONFIG_PATH" ]] && [[ ! -d "$FULL_PATH" ]]; then
            echo "‚ùå Error: Configuration directory not found: $CONFIG_PATH"
            echo "Available configurations:"
            ls -la "${{ github.workspace }}/lint-config/linting/config/" || echo "No configurations found"
            exit 1
          fi
          
          echo "‚úÖ Configuration directory verified"
          
      - name: Check for existing configuration files and directories
        id: check-existing
        run: |
          echo "üîç Checking for existing configuration files in workspace..."
          
          # Combine files and directories to check
          ITEMS_TO_CHECK="$CONFIG_FILES $CONFIG_DIRS"
          EXISTING_ITEMS=()
          
          # Check each file and directory
          for item in $ITEMS_TO_CHECK; do
            if [[ -e "${{ github.workspace }}/$item" ]]; then
              EXISTING_ITEMS+=("$item")
            fi
          done
          
          if [[ ${#EXISTING_ITEMS[@]} -gt 0 ]]; then
            echo "‚ö†Ô∏è WARNING: Found existing configuration files/directories in workspace:"
            printf '%s\n' "${EXISTING_ITEMS[@]}"
            echo ""
            
            STRATEGY="${{ steps.validate-strategy.outputs.strategy }}"
            case "$STRATEGY" in
              replace)
                echo "These items will be replaced by the tooling configuration."
                ;;
              keep)
                echo "These items will be kept. New configuration will only be added if they don't exist."
                ;;
              fail)
                echo "‚ùå Error: Configuration files/directories already exist and strategy is 'fail'"
                echo "Remove these items or use a different strategy (replace or keep)"
                exit 1
                ;;
            esac
            echo "has_existing=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ No existing configuration files/directories found"
            echo "has_existing=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Copy all configuration from tooling repository to workspace root
        run: |
          CONFIG_PATH="${{ steps.validate-config.outputs.path }}"
          SOURCE_PATH="${{ github.workspace }}/lint-config/linting/config/${CONFIG_PATH}"
          STRATEGY="${{ steps.validate-strategy.outputs.strategy }}"
          
          # Determine the source directory
          if [[ -n "$CONFIG_PATH" ]]; then
            echo "üìÅ Copying configuration from: $CONFIG_PATH"
            SOURCE="${SOURCE_PATH}/"
          else
            echo "üìÅ Copying root configuration"
            SOURCE="${{ github.workspace }}/lint-config/linting/config/"
          fi
          
          # Apply strategy-specific rsync options
          # Note: rsync copies ALL files/directories from source, not just those in CONFIG_FILES/CONFIG_DIRS
          case "$STRATEGY" in
            replace)
              echo "üìù Strategy: Replace existing files (with backup)"
              rsync -av --backup --suffix=".workspace-original" --exclude='.git' "$SOURCE" "${{ github.workspace }}/"
              ;;
            keep)
              echo "üìù Strategy: Keep existing files"
              rsync -av --ignore-existing --exclude='.git' "$SOURCE" "${{ github.workspace }}/"
              ;;
            fail)
              echo "üìù Strategy: Fail if files exist (already checked above)"
              rsync -av --exclude='.git' "$SOURCE" "${{ github.workspace }}/"
              ;;
          esac
          
          # List specific configuration files and directories to verify they were copied
          echo ""
          echo "üìã Verifying expected configuration items in workspace:"
          
          # Check files
          for file in $CONFIG_FILES; do
            if [[ -f "${{ github.workspace }}/$file" ]]; then
              echo "  ‚úì $file"
            else
              echo "  ‚úó $file (not found)"
            fi
          done
          
          # Check directories
          for dir in $CONFIG_DIRS; do
            if [[ -d "${{ github.workspace }}/$dir" ]]; then
              echo "  ‚úì $dir/ (directory)"
            else
              echo "  ‚úó $dir/ (directory not found)"
            fi
          done
          
          # Show which files were replaced (rsync creates .workspace-original files for replaced items)
          if [[ "$STRATEGY" == "replace" ]]; then
            echo ""
            BACKUP_COUNT=$(find . -maxdepth 1 -name "*.workspace-original" 2>/dev/null | wc -l)
            if [[ $BACKUP_COUNT -gt 0 ]]; then
              echo "üìù Files replaced by tooling configuration: $BACKUP_COUNT file(s)"
              find . -maxdepth 1 -name "*.workspace-original" | sort | sed 's/\.workspace-original$//' | sed 's/^\.\//  /'
            fi
          fi
          
      - name: MegaLinter
        id: ml
        # Using c_cpp flavor v7 as in original workflow
        uses: oxsecurity/megalinter/flavors/c_cpp@v7
        env:
          # Core settings
          VALIDATE_ALL_CODEBASE: true
          PRINT_ALPACA: false
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
          # Reporting
          GITHUB_COMMENT_REPORTER: true
          GITHUB_STATUS_REPORTER: true
          
          # Disabled categories and linters
          DISABLE: COPYPASTE,SPELL,JAVASCRIPT,MARKDOWN
          # Fix: DISABLE_LINTERS should be comma-separated, not comma-space separated
          DISABLE_LINTERS: OPENAPI_SPECTRAL,YAML_PRETTIER,REPOSITORY_GRYPE,REPOSITORY_SEMGREP,REPOSITORY_DEVSKIM,REPOSITORY_KICS,REPOSITORY_TRIVY,REPOSITORY_TRIVY_SBOM,REPOSITORY_TRUFFLEHOG,REPOSITORY_CHECKOV,REPOSITORY_GITLEAKS,YAML_V8R,JAVA_PMD
          
          # Configuration files (explicitly specified for clarity)
          API_SPECTRAL_CONFIG_FILE: .spectral.yaml
          YAML_YAMLLINT_CONFIG_FILE: .yamllint.yaml
          GHERKIN_GHERKIN_LINT_CONFIG_FILE: .gherkin-lintrc
          # Note: The lint-function directory will be automatically detected by MegaLinter
          
          # Path filters
          API_SPECTRAL_FILTER_REGEX_INCLUDE: (code/API_definitions/)
          YAML_YAMLLINT_FILTER_REGEX_INCLUDE: (code/API_definitions/)
          GHERKIN_GHERKIN_LINT_FILTER_REGEX_INCLUDE: (code/Test_definitions/)
          
      - name: Archive production artifacts
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: MegaLinter reports
          include-hidden-files: true
          path: |
            megalinter-reports
            mega-linter.log

# Commented out changelog job remains the same...
#  changelog-changed-job:
#    runs-on: ubuntu-latest
#    
#    steps:
#    - name: Checkout repository
#      uses: actions/checkout@v4
#      with:
#        fetch-depth: 2
#    
#    - name: Check if changelog was updated
#      id: changelog-changed
#      uses: tj-actions/changed-files@ed68ef82c095e0d48ec87eccea555d944a631a4c # v46 
#      with:
#        files: |
#          CHANGELOG.MD
#          CHANGELOG.md
#    
#    - name: Custom job logic
#      if: steps.changelog-changed.outputs.any_changed == 'true'
#      run: |
#        echo "üöÄ Changelog was updated! Running custom job..."
#        
#        # Add your custom logic here
#        echo "Performing custom actions:"
#        echo "‚úÖ Step 1: Custom processing"
#        echo "‚úÖ Step 2: Your business logic"
#        echo "‚úÖ Step 3: Additional operations"
#        
#        # Example: Parse changelog for latest entry
#        echo "Latest changelog entry:"
#        head -20 CHANGELOG.md || head -20 CHANGELOG.MD || echo "No changelog found"
#    
#    - name: Skip message
#      if: steps.changelog-changed.outputs.any_changed != 'true'
#      run: |
#        echo "‚ÑπÔ∏è Changelog not updated, skipping custom job"